"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _v = _interopRequireDefault(require("uuid/v4"));

var _keys = require("blockstack/lib/keys");

var _encryption = require("blockstack/lib/encryption");

var _wolfy87Eventemitter = _interopRequireDefault(require("wolfy87-eventemitter"));

var _helpers = require("./helpers");

var _api = require("./api");

var _streamer = _interopRequireDefault(require("./streamer"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

const EVENT_NAME = 'MODEL_STREAM_EVENT';

let Model =
/*#__PURE__*/
function () {
  _createClass(Model, null, [{
    key: "fromSchema",
    value: function fromSchema(schema) {
      this.schema = schema;
      return this;
    }
  }, {
    key: "fetchList",
    value: async function fetchList(_selector = {}, {
      decrypt = true
    } = {}) {
      const selector = _objectSpread({}, _selector, {
        radiksType: this.modelName()
      });

      const {
        results
      } = await (0, _api.find)(selector);
      const Clazz = this;
      const modelDecryptions = results.map(doc => {
        const model = new Clazz(doc);

        if (decrypt) {
          return model.decrypt();
        }

        return Promise.resolve(model);
      });
      const models = await Promise.all(modelDecryptions);
      return models;
    }
  }, {
    key: "findOne",
    value: async function findOne(_selector = {}, options = {
      decrypt: true
    }) {
      const selector = _objectSpread({}, _selector, {
        limit: 1
      });

      const results = await this.fetchList(selector, options);
      return results[0];
    }
  }, {
    key: "findById",
    value: async function findById(_id, fetchOptions) {
      const Clazz = this;
      const model = new Clazz({
        _id
      });
      return model.fetch(fetchOptions);
    }
  }, {
    key: "count",
    value: async function count(_selector = {}) {
      const selector = _objectSpread({}, _selector, {
        radiksType: this.modelName()
      });

      const data = await (0, _api.count)(selector);
      return data.total;
    }
    /**
     * Fetch all models that are owned by the current user.
     * This only includes 'personally' owned models, and not those created
     * as part of a UserGroup
     *
     * @param {Object} _selector - A query to include when fetching models
     */

  }, {
    key: "fetchOwnList",
    value: function fetchOwnList(_selector = {}) {
      const {
        _id
      } = (0, _helpers.userGroupKeys)().personal;

      const selector = _objectSpread({}, _selector, {
        signingKeyId: _id
      });

      return this.fetchList(selector);
    }
  }]);

  function Model(attrs = {}) {
    _classCallCheck(this, Model);

    _defineProperty(this, "schema", void 0);

    _defineProperty(this, "_id", void 0);

    _defineProperty(this, "attrs", void 0);

    const {
      schema,
      defaults
    } = this.constructor;
    const name = this.modelName();
    this.schema = schema;
    this._id = attrs._id || (0, _v.default)().replace('-', '');
    this.attrs = _objectSpread({}, defaults, attrs, {
      radiksType: name
    });
  }

  _createClass(Model, [{
    key: "save",
    value: async function save() {
      return new Promise(async (resolve, reject) => {
        try {
          if (this.beforeSave) {
            await this.beforeSave();
          }

          const now = new Date().getTime();
          this.attrs.createdAt = this.attrs.createdAt || now;
          this.attrs.updatedAt = now;
          await this.setUsername();
          await this.sign();
          const encrypted = await this.encrypted();
          const gaiaURL = await this.saveFile(encrypted);
          await (0, _api.sendNewGaiaUrl)(gaiaURL);
          resolve(this);
        } catch (error) {
          reject(error);
        }
      });
    }
  }, {
    key: "encrypted",
    value: function encrypted() {
      return (0, _helpers.encryptObject)(this);
    }
  }, {
    key: "saveFile",
    value: function saveFile(encrypted) {
      const userSession = (0, _helpers.requireUserSession)();
      return userSession.putFile(this.blockstackPath(), JSON.stringify(encrypted), {
        encrypt: false
      });
    }
  }, {
    key: "deleteFile",
    value: function deleteFile() {
      const userSession = (0, _helpers.requireUserSession)();
      return userSession.deleteFile(this.blockstackPath());
    }
  }, {
    key: "blockstackPath",
    value: function blockstackPath() {
      const path = `${this.modelName()}/${this._id}`;
      return path;
    }
  }, {
    key: "setUsername",
    value: function setUsername() {
      const {
        validateUsername
      } = this.constructor;

      if (validateUsername) {
        const userSession = (0, _helpers.requireUserSession)();
        const {
          username,
          gaiaHubConfig
        } = userSession.loadUserData();
        this.attrs.username = username; // eslint-disable-next-line @typescript-eslint/camelcase

        const {
          url_prefix,
          address
        } = gaiaHubConfig; // eslint-disable-next-line @typescript-eslint/camelcase

        this.attrs.gaiaURL = `${url_prefix}${address}/${this.blockstackPath()}`;
      }
    }
  }, {
    key: "fetch",
    value: async function fetch({
      decrypt = true
    } = {}) {
      const query = {
        _id: this._id
      };
      const {
        results
      } = await (0, _api.find)(query);
      const [attrs] = results; // Object not found on the server so we return undefined

      if (!attrs) {
        return undefined;
      }

      this.attrs = _objectSpread({}, this.attrs, attrs);

      if (decrypt) {
        await this.decrypt();
      }

      await this.afterFetch();
      return this;
    }
  }, {
    key: "decrypt",
    value: async function decrypt() {
      this.attrs = await (0, _helpers.decryptObject)(this.attrs, this);
      return this;
    }
  }, {
    key: "update",
    value: function update(attrs) {
      this.attrs = _objectSpread({}, this.attrs, attrs);
    }
  }, {
    key: "sign",
    value: async function sign() {
      if (this.attrs.updatable === false) {
        return true;
      }

      const signingKey = this.getSigningKey();
      this.attrs.signingKeyId = this.attrs.signingKeyId || signingKey._id;
      const {
        privateKey
      } = signingKey;
      const contentToSign = [this._id];

      if (this.attrs.updatedAt) {
        contentToSign.push(this.attrs.updatedAt);
      }

      const {
        signature
      } = (0, _encryption.signECDSA)(privateKey, contentToSign.join('-'));
      this.attrs.radiksSignature = signature;
      return this;
    }
  }, {
    key: "getSigningKey",
    value: function getSigningKey() {
      if (this.attrs.userGroupId) {
        const {
          userGroups,
          signingKeys
        } = (0, _helpers.userGroupKeys)();
        const _id = userGroups[this.attrs.userGroupId];
        const privateKey = signingKeys[_id];
        return {
          _id,
          privateKey
        };
      }

      return (0, _helpers.userGroupKeys)().personal;
    }
  }, {
    key: "encryptionPublicKey",
    value: async function encryptionPublicKey() {
      return (0, _keys.getPublicKeyFromPrivate)(this.encryptionPrivateKey());
    }
  }, {
    key: "encryptionPrivateKey",
    value: function encryptionPrivateKey() {
      let privateKey;

      if (this.attrs.userGroupId) {
        const {
          userGroups,
          signingKeys
        } = (0, _helpers.userGroupKeys)();
        privateKey = signingKeys[userGroups[this.attrs.userGroupId]];
      } else {
        privateKey = (0, _helpers.requireUserSession)().loadUserData().appPrivateKey;
      }

      return privateKey;
    }
  }, {
    key: "modelName",
    value: function modelName() {
      const {
        modelName
      } = this.constructor;
      return modelName.apply(this.constructor);
    }
  }, {
    key: "isOwnedByUser",
    value: function isOwnedByUser() {
      const keys = (0, _helpers.userGroupKeys)();

      if (this.attrs.signingKeyId === keys.personal._id) {
        return true;
      }

      if (this.attrs.userGroupId) {
        let isOwned = false;
        Object.keys(keys.userGroups).forEach(groupId => {
          if (groupId === this.attrs.userGroupId) {
            isOwned = true;
          }
        });
        return isOwned;
      }

      return false;
    }
  }, {
    key: "destroy",
    value: async function destroy() {
      await this.sign();
      await this.deleteFile();
      return (0, _api.destroyModel)(this);
    } // @abstract

  }, {
    key: "beforeSave",
    value: function beforeSave() {} // @abstract

  }, {
    key: "afterFetch",
    value: function afterFetch() {}
  }], [{
    key: "modelName",
    value: function modelName() {
      return this.className || this.name;
    }
  }, {
    key: "addStreamListener",
    value: function addStreamListener(callback) {
      if (!this.emitter) {
        this.emitter = new _wolfy87Eventemitter.default();
      }

      if (this.emitter.getListeners().length === 0) {
        _streamer.default.addListener(args => {
          this.onStreamEvent(this, args);
        });
      }

      this.emitter.addListener(EVENT_NAME, callback);
    }
  }, {
    key: "removeStreamListener",
    value: function removeStreamListener(callback) {
      this.emitter.removeListener(EVENT_NAME, callback);

      if (this.emitter.getListeners().length === 0) {
        _streamer.default.removeListener(this.onStreamEvent);
      }
    }
  }]);

  return Model;
}();

exports.default = Model;

_defineProperty(Model, "schema", void 0);

_defineProperty(Model, "defaults", {});

_defineProperty(Model, "className", void 0);

_defineProperty(Model, "emitter", void 0);

_defineProperty(Model, "validateUsername", false);

_defineProperty(Model, "onStreamEvent", (_this, [event]) => {
  try {
    const {
      data
    } = event;
    const attrs = JSON.parse(data);

    if (attrs && attrs.radiksType === _this.modelName()) {
      const model = new _this(attrs);

      if (model.isOwnedByUser()) {
        model.decrypt().then(() => {
          _this.emitter.emit(EVENT_NAME, model);
        });
      } else {
        _this.emitter.emit(EVENT_NAME, model);
      }
    }
  } catch (error) {// console.error(error.message);
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9tb2RlbC50cyJdLCJuYW1lcyI6WyJFVkVOVF9OQU1FIiwiTW9kZWwiLCJzY2hlbWEiLCJfc2VsZWN0b3IiLCJkZWNyeXB0Iiwic2VsZWN0b3IiLCJyYWRpa3NUeXBlIiwibW9kZWxOYW1lIiwicmVzdWx0cyIsIkNsYXp6IiwibW9kZWxEZWNyeXB0aW9ucyIsIm1hcCIsImRvYyIsIm1vZGVsIiwiUHJvbWlzZSIsInJlc29sdmUiLCJtb2RlbHMiLCJhbGwiLCJvcHRpb25zIiwibGltaXQiLCJmZXRjaExpc3QiLCJfaWQiLCJmZXRjaE9wdGlvbnMiLCJmZXRjaCIsImRhdGEiLCJ0b3RhbCIsInBlcnNvbmFsIiwic2lnbmluZ0tleUlkIiwiYXR0cnMiLCJkZWZhdWx0cyIsImNvbnN0cnVjdG9yIiwibmFtZSIsInJlcGxhY2UiLCJyZWplY3QiLCJiZWZvcmVTYXZlIiwibm93IiwiRGF0ZSIsImdldFRpbWUiLCJjcmVhdGVkQXQiLCJ1cGRhdGVkQXQiLCJzZXRVc2VybmFtZSIsInNpZ24iLCJlbmNyeXB0ZWQiLCJnYWlhVVJMIiwic2F2ZUZpbGUiLCJlcnJvciIsInVzZXJTZXNzaW9uIiwicHV0RmlsZSIsImJsb2Nrc3RhY2tQYXRoIiwiSlNPTiIsInN0cmluZ2lmeSIsImVuY3J5cHQiLCJkZWxldGVGaWxlIiwicGF0aCIsInZhbGlkYXRlVXNlcm5hbWUiLCJ1c2VybmFtZSIsImdhaWFIdWJDb25maWciLCJsb2FkVXNlckRhdGEiLCJ1cmxfcHJlZml4IiwiYWRkcmVzcyIsInF1ZXJ5IiwidW5kZWZpbmVkIiwiYWZ0ZXJGZXRjaCIsInVwZGF0YWJsZSIsInNpZ25pbmdLZXkiLCJnZXRTaWduaW5nS2V5IiwicHJpdmF0ZUtleSIsImNvbnRlbnRUb1NpZ24iLCJwdXNoIiwic2lnbmF0dXJlIiwiam9pbiIsInJhZGlrc1NpZ25hdHVyZSIsInVzZXJHcm91cElkIiwidXNlckdyb3VwcyIsInNpZ25pbmdLZXlzIiwiZW5jcnlwdGlvblByaXZhdGVLZXkiLCJhcHBQcml2YXRlS2V5IiwiYXBwbHkiLCJrZXlzIiwiaXNPd25lZCIsIk9iamVjdCIsImZvckVhY2giLCJncm91cElkIiwiY2xhc3NOYW1lIiwiY2FsbGJhY2siLCJlbWl0dGVyIiwiRXZlbnRFbWl0dGVyIiwiZ2V0TGlzdGVuZXJzIiwibGVuZ3RoIiwiU3RyZWFtZXIiLCJhZGRMaXN0ZW5lciIsImFyZ3MiLCJvblN0cmVhbUV2ZW50IiwicmVtb3ZlTGlzdGVuZXIiLCJfdGhpcyIsImV2ZW50IiwicGFyc2UiLCJpc093bmVkQnlVc2VyIiwidGhlbiIsImVtaXQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQTs7QUFNQTs7QUFHQTs7Ozs7Ozs7Ozs7Ozs7QUFHQSxNQUFNQSxVQUFVLEdBQUcsb0JBQW5COztJQVVxQkMsSzs7Ozs7K0JBVURDLE0sRUFBZ0I7QUFDaEMsV0FBS0EsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsYUFBTyxJQUFQO0FBQ0Q7OztvQ0FHQ0MsU0FBb0IsR0FBRyxFLEVBQ3ZCO0FBQUVDLE1BQUFBLE9BQU8sR0FBRztBQUFaLFFBQW1DLEUsRUFDbkM7QUFDQSxZQUFNQyxRQUFtQixxQkFDcEJGLFNBRG9CO0FBRXZCRyxRQUFBQSxVQUFVLEVBQUUsS0FBS0MsU0FBTDtBQUZXLFFBQXpCOztBQUlBLFlBQU07QUFBRUMsUUFBQUE7QUFBRixVQUFjLE1BQU0sZUFBS0gsUUFBTCxDQUExQjtBQUNBLFlBQU1JLEtBQUssR0FBRyxJQUFkO0FBQ0EsWUFBTUMsZ0JBQThCLEdBQUdGLE9BQU8sQ0FBQ0csR0FBUixDQUFhQyxHQUFELElBQWM7QUFDL0QsY0FBTUMsS0FBSyxHQUFHLElBQUlKLEtBQUosQ0FBVUcsR0FBVixDQUFkOztBQUNBLFlBQUlSLE9BQUosRUFBYTtBQUNYLGlCQUFPUyxLQUFLLENBQUNULE9BQU4sRUFBUDtBQUNEOztBQUNELGVBQU9VLE9BQU8sQ0FBQ0MsT0FBUixDQUFnQkYsS0FBaEIsQ0FBUDtBQUNELE9BTnNDLENBQXZDO0FBT0EsWUFB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QUNGLEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdXVpZCBmcm9tICd1dWlkL3Y0JztcbmltcG9ydCB7IGdldFB1YmxpY0tleUZyb21Qcml2YXRlIH0gZnJvbSAnYmxvY2tzdGFjay9saWIva2V5cyc7XG5pbXBvcnQgeyBzaWduRUNEU0EgfSBmcm9tICdibG9ja3N0YWNrL2xpYi9lbmNyeXB0aW9uJztcbmltcG9ydCBFdmVudEVtaXR0ZXIgZnJvbSAnd29sZnk4Ny1ldmVudGVtaXR0ZXInO1xuXG5pbXBvcnQge1xuICBlbmNyeXB0T2JqZWN0LFxuICBkZWNyeXB0T2JqZWN0LFxuICB1c2VyR3JvdXBLZXlzLFxuICByZXF1aXJlVXNlclNlc3Npb24sXG59IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQge1xuICBzZW5kTmV3R2FpYVVybCwgZmluZCwgY291bnQsIEZpbmRRdWVyeSwgZGVzdHJveU1vZGVsLFxufSBmcm9tICcuL2FwaSc7XG5pbXBvcnQgU3RyZWFtZXIgZnJvbSAnLi9zdHJlYW1lcic7XG5pbXBvcnQgeyBTY2hlbWEsIEF0dHJzIH0gZnJvbSAnLi90eXBlcy9pbmRleCc7XG5cbmNvbnN0IEVWRU5UX05BTUUgPSAnTU9ERUxfU1RSRUFNX0VWRU5UJztcblxuaW50ZXJmYWNlIEZldGNoT3B0aW9ucyB7XG4gIGRlY3J5cHQ/OiBib29sZWFuO1xufVxuXG5pbnRlcmZhY2UgRXZlbnQge1xuICBkYXRhOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vZGVsIHtcbiAgcHVibGljIHN0YXRpYyBzY2hlbWE6IFNjaGVtYTtcbiAgcHVibGljIHN0YXRpYyBkZWZhdWx0czogYW55ID0ge307XG4gIHB1YmxpYyBzdGF0aWMgY2xhc3NOYW1lPzogc3RyaW5nO1xuICBwdWJsaWMgc3RhdGljIGVtaXR0ZXI/OiBFdmVudEVtaXR0ZXI7XG4gIHB1YmxpYyBzdGF0aWMgdmFsaWRhdGVVc2VybmFtZSA9IGZhbHNlO1xuICBzY2hlbWE6IFNjaGVtYTtcbiAgX2lkOiBzdHJpbmc7XG4gIGF0dHJzOiBBdHRycztcblxuICBzdGF0aWMgZnJvbVNjaGVtYShzY2hlbWE6IFNjaGVtYSkge1xuICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGZldGNoTGlzdDxUIGV4dGVuZHMgTW9kZWw+KFxuICAgIF9zZWxlY3RvcjogRmluZFF1ZXJ5ID0ge30sXG4gICAgeyBkZWNyeXB0ID0gdHJ1ZSB9OiBGZXRjaE9wdGlvbnMgPSB7fSxcbiAgKSB7XG4gICAgY29uc3Qgc2VsZWN0b3I6IEZpbmRRdWVyeSA9IHtcbiAgICAgIC4uLl9zZWxlY3RvcixcbiAgICAgIHJhZGlrc1R5cGU6IHRoaXMubW9kZWxOYW1lKCksXG4gICAgfTtcbiAgICBjb25zdCB7IHJlc3VsdHMgfSA9IGF3YWl0IGZpbmQoc2VsZWN0b3IpO1xuICAgIGNvbnN0IENsYXp6ID0gdGhpcztcbiAgICBjb25zdCBtb2RlbERlY3J5cHRpb25zOiBQcm9taXNlPFQ+W10gPSByZXN1bHRzLm1hcCgoZG9jOiBhbnkpID0+IHtcbiAgICAgIGNvbnN0IG1vZGVsID0gbmV3IENsYXp6KGRvYyk7XG4gICAgICBpZiAoZGVjcnlwdCkge1xuICAgICAgICByZXR1cm4gbW9kZWwuZGVjcnlwdCgpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShtb2RlbCk7XG4gICAgfSk7XG4gICAgY29uc3QgbW9kZWxzOiBUW10gPSBhd2FpdCBQcm9taXNlLmFsbChtb2RlbERlY3J5cHRpb25zKTtcbiAgICByZXR1cm4gbW9kZWxzO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGZpbmRPbmU8VCBleHRlbmRzIE1vZGVsPihcbiAgICBfc2VsZWN0b3I6IEZpbmRRdWVyeSA9IHt9LFxuICAgIG9wdGlvbnM6IEZldGNoT3B0aW9ucyA9IHsgZGVjcnlwdDogdHJ1ZSB9LFxuICApIHtcbiAgICBjb25zdCBzZWxlY3RvcjogRmluZFF1ZXJ5ID0ge1xuICAgICAgLi4uX3NlbGVjdG9yLFxuICAgICAgbGltaXQ6IDEsXG4gICAgfTtcbiAgICBjb25zdCByZXN1bHRzOiBUW10gPSBhd2FpdCB0aGlzLmZldGNoTGlzdChzZWxlY3Rvciwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHJlc3VsdHNbMF07XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgZmluZEJ5SWQ8VCBleHRlbmRzIE1vZGVsPihcbiAgICBfaWQ6IHN0cmluZyxcbiAgICBmZXRjaE9wdGlvbnM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICApIHtcbiAgICBjb25zdCBDbGF6eiA9IHRoaXM7XG4gICAgY29uc3QgbW9kZWw6IE1vZGVsID0gbmV3IENsYXp6KHsgX2lkIH0pO1xuICAgIHJldHVybiBtb2RlbC5mZXRjaChmZXRjaE9wdGlvbnMpO1xuICB9XG5cbiAgc3RhdGljIGFzeW5jIGNvdW50KF9zZWxlY3RvcjogRmluZFF1ZXJ5ID0ge30pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHNlbGVjdG9yOiBGaW5kUXVlcnkgPSB7XG4gICAgICAuLi5fc2VsZWN0b3IsXG4gICAgICByYWRpa3NUeXBlOiB0aGlzLm1vZGVsTmFtZSgpLFxuICAgIH07XG4gICAgY29uc3QgZGF0YSA9IGF3YWl0IGNvdW50KHNlbGVjdG9yKTtcbiAgICByZXR1cm4gZGF0YS50b3RhbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCBhbGwgbW9kZWxzIHRoYXQgYXJlIG93bmVkIGJ5IHRoZSBjdXJyZW50IHVzZXIuXG4gICAqIFRoaXMgb25seSBpbmNsdWRlcyAncGVyc29uYWxseScgb3duZWQgbW9kZWxzLCBhbmQgbm90IHRob3NlIGNyZWF0ZWRcbiAgICogYXMgcGFydCBvZiBhIFVzZXJHcm91cFxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gX3NlbGVjdG9yIC0gQSBxdWVyeSB0byBpbmNsdWRlIHdoZW4gZmV0Y2hpbmcgbW9kZWxzXG4gICAqL1xuICBzdGF0aWMgZmV0Y2hPd25MaXN0KF9zZWxlY3RvcjogRmluZFF1ZXJ5ID0ge30pIHtcbiAgICBjb25zdCB7IF9pZCB9ID0gdXNlckdyb3VwS2V5cygpLnBlcnNvbmFsO1xuICAgIGNvbnN0IHNlbGVjdG9yID0ge1xuICAgICAgLi4uX3NlbGVjdG9yLFxuICAgICAgc2lnbmluZ0tleUlkOiBfaWQsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5mZXRjaExpc3Qoc2VsZWN0b3IpO1xuICB9XG5cbiAgY29uc3RydWN0b3IoYXR0cnM6IEF0dHJzID0ge30pIHtcbiAgICBjb25zdCB7IHNjaGVtYSwgZGVmYXVsdHMgfSA9IHRoaXMuY29uc3RydWN0b3IgYXMgdHlwZW9mIE1vZGVsO1xuICAgIGNvbnN0IG5hbWUgPSB0aGlzLm1vZGVsTmFtZSgpO1xuICAgIHRoaXMuc2NoZW1hID0gc2NoZW1hO1xuICAgIHRoaXMuX2lkID0gYXR0cnMuX2lkIHx8IHV1aWQoKS5yZXBsYWNlKCctJywgJycpO1xuICAgIHRoaXMuYXR0cnMgPSB7XG4gICAgICAuLi5kZWZhdWx0cyxcbiAgICAgIC4uLmF0dHJzLFxuICAgICAgcmFkaWtzVHlwZTogbmFtZSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgc2F2ZSgpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgaWYgKHRoaXMuYmVmb3JlU2F2ZSkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuYmVmb3JlU2F2ZSgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLmF0dHJzLmNyZWF0ZWRBdCA9IHRoaXMuYXR0cnMuY3JlYXRlZEF0IHx8IG5vdztcbiAgICAgICAgdGhpcy5hdHRycy51cGRhdGVkQXQgPSBub3c7XG4gICAgICAgIGF3YWl0IHRoaXMuc2V0VXNlcm5hbWUoKTtcbiAgICAgICAgYXdhaXQgdGhpcy5zaWduKCk7XG4gICAgICAgIGNvbnN0IGVuY3J5cHRlZCA9IGF3YWl0IHRoaXMuZW5jcnlwdGVkKCk7XG4gICAgICAgIGNvbnN0IGdhaWFVUkwgPSBhd2FpdCB0aGlzLnNhdmVGaWxlKGVuY3J5cHRlZCk7XG4gICAgICAgIGF3YWl0IHNlbmROZXdHYWlhVXJsKGdhaWFVUkwpO1xuICAgICAgICByZXNvbHZlKHRoaXMpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGVuY3J5cHRlZCgpIHtcbiAgICByZXR1cm4gZW5jcnlwdE9iamVjdCh0aGlzKTtcbiAgfVxuXG4gIHNhdmVGaWxlKGVuY3J5cHRlZDogUmVjb3JkPHN0cmluZywgYW55Pikge1xuICAgIGNvbnN0IHVzZXJTZXNzaW9uID0gcmVxdWlyZVVzZXJTZXNzaW9uKCk7XG4gICAgcmV0dXJuIHVzZXJTZXNzaW9uLnB1dEZpbGUoXG4gICAgICB0aGlzLmJsb2Nrc3RhY2tQYXRoKCksXG4gICAgICBKU09OLnN0cmluZ2lmeShlbmNyeXB0ZWQpLFxuICAgICAge1xuICAgICAgICBlbmNyeXB0OiBmYWxzZSxcbiAgICAgIH0sXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZUZpbGUoKSB7XG4gICAgY29uc3QgdXNlclNlc3Npb24gPSByZXF1aXJlVXNlclNlc3Npb24oKTtcbiAgICByZXR1cm4gdXNlclNlc3Npb24uZGVsZXRlRmlsZSh0aGlzLmJsb2Nrc3RhY2tQYXRoKCkpO1xuICB9XG5cbiAgYmxvY2tzdGFja1BhdGgoKSB7XG4gICAgY29uc3QgcGF0aCA9IGAke3RoaXMubW9kZWxOYW1lKCl9LyR7dGhpcy5faWR9YDtcbiAgICByZXR1cm4gcGF0aDtcbiAgfVxuXG4gIHNldFVzZXJuYW1lKCkge1xuICAgIGNvbnN0IHsgdmFsaWRhdGVVc2VybmFtZSB9ID0gdGhpcy5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgTW9kZWw7XG4gICAgaWYgKHZhbGlkYXRlVXNlcm5hbWUpIHtcbiAgICAgIGNvbnN0IHVzZXJTZXNzaW9uID0gcmVxdWlyZVVzZXJTZXNzaW9uKCk7XG4gICAgICBjb25zdCB7IHVzZXJuYW1lLCBnYWlhSHViQ29uZmlnIH0gPSB1c2VyU2Vzc2lvbi5sb2FkVXNlckRhdGEoKTtcbiAgICAgIHRoaXMuYXR0cnMudXNlcm5hbWUgPSB1c2VybmFtZTtcbiAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvY2FtZWxjYXNlXG4gICAgICBjb25zdCB7IHVybF9wcmVmaXgsIGFkZHJlc3MgfSA9IGdhaWFIdWJDb25maWc7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2NhbWVsY2FzZVxuICAgICAgdGhpcy5hdHRycy5nYWlhVVJMID0gYCR7dXJsX3ByZWZpeH0ke2FkZHJlc3N9LyR7dGhpcy5ibG9ja3N0YWNrUGF0aCgpfWA7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmV0Y2goeyBkZWNyeXB0ID0gdHJ1ZSB9ID0ge30pOiBQcm9taXNlPHRoaXMgfCB1bmRlZmluZWQ+IHtcbiAgICBjb25zdCBxdWVyeSA9IHtcbiAgICAgIF9pZDogdGhpcy5faWQsXG4gICAgfTtcbiAgICBjb25zdCB7IHJlc3VsdHMgfSA9IGF3YWl0IGZpbmQocXVlcnkpO1xuICAgIGNvbnN0IFthdHRyc10gPSByZXN1bHRzO1xuICAgIC8vIE9iamVjdCBub3QgZm91bmQgb24gdGhlIHNlcnZlciBzbyB3ZSByZXR1cm4gdW5kZWZpbmVkXG4gICAgaWYgKCFhdHRycykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgdGhpcy5hdHRycyA9IHtcbiAgICAgIC4uLnRoaXMuYXR0cnMsXG4gICAgICAuLi5hdHRycyxcbiAgICB9O1xuICAgIGlmIChkZWNyeXB0KSB7XG4gICAgICBhd2FpdCB0aGlzLmRlY3J5cHQoKTtcbiAgICB9XG4gICAgYXdhaXQgdGhpcy5hZnRlckZldGNoKCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBhc3luYyBkZWNyeXB0KCkge1xuICAgIHRoaXMuYXR0cnMgPSBhd2FpdCBkZWNyeXB0T2JqZWN0KHRoaXMuYXR0cnMsIHRoaXMpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgdXBkYXRlKGF0dHJzOiBBdHRycykge1xuICAgIHRoaXMuYXR0cnMgPSB7XG4gICAgICAuLi50aGlzLmF0dHJzLFxuICAgICAgLi4uYXR0cnMsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIHNpZ24oKSB7XG4gICAgaWYgKHRoaXMuYXR0cnMudXBkYXRhYmxlID09PSBmYWxzZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGNvbnN0IHNpZ25pbmdLZXkgPSB0aGlzLmdldFNpZ25pbmdLZXkoKTtcbiAgICB0aGlzLmF0dHJzLnNpZ25pbmdLZXlJZCA9IHRoaXMuYXR0cnMuc2lnbmluZ0tleUlkIHx8IHNpZ25pbmdLZXkuX2lkO1xuICAgIGNvbnN0IHsgcHJpdmF0ZUtleSB9ID0gc2lnbmluZ0tleTtcbiAgICBjb25zdCBjb250ZW50VG9TaWduOiAoc3RyaW5nIHwgbnVtYmVyKVtdID0gW3RoaXMuX2lkXTtcbiAgICBpZiAodGhpcy5hdHRycy51cGRhdGVkQXQpIHtcbiAgICAgIGNvbnRlbnRUb1NpZ24ucHVzaCh0aGlzLmF0dHJzLnVwZGF0ZWRBdCk7XG4gICAgfVxuICAgIGNvbnN0IHsgc2lnbmF0dXJlIH0gPSBzaWduRUNEU0EocHJpdmF0ZUtleSwgY29udGVudFRvU2lnbi5qb2luKCctJykpO1xuICAgIHRoaXMuYXR0cnMucmFkaWtzU2lnbmF0dXJlID0gc2lnbmF0dXJlO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgZ2V0U2lnbmluZ0tleSgpIHtcbiAgICBpZiAodGhpcy5hdHRycy51c2VyR3JvdXBJZCkge1xuICAgICAgY29uc3QgeyB1c2VyR3JvdXBzLCBzaWduaW5nS2V5cyB9ID0gdXNlckdyb3VwS2V5cygpO1xuXG4gICAgICBjb25zdCBfaWQgPSB1c2VyR3JvdXBzW3RoaXMuYXR0cnMudXNlckdyb3VwSWRdO1xuICAgICAgY29uc3QgcHJpdmF0ZUtleSA9IHNpZ25pbmdLZXlzW19pZF07XG4gICAgICByZXR1cm4ge1xuICAgICAgICBfaWQsXG4gICAgICAgIHByaXZhdGVLZXksXG4gICAgICB9O1xuICAgIH1cbiAgICByZXR1cm4gdXNlckdyb3VwS2V5cygpLnBlcnNvbmFsO1xuICB9XG5cbiAgYXN5bmMgZW5jcnlwdGlvblB1YmxpY0tleSgpIHtcbiAgICByZXR1cm4gZ2V0UHVibGljS2V5RnJvbVByaXZhdGUodGhpcy5lbmNyeXB0aW9uUHJpdmF0ZUtleSgpKTtcbiAgfVxuXG4gIGVuY3J5cHRpb25Qcml2YXRlS2V5KCkge1xuICAgIGxldCBwcml2YXRlS2V5OiBzdHJpbmc7XG4gICAgaWYgKHRoaXMuYXR0cnMudXNlckdyb3VwSWQpIHtcbiAgICAgIGNvbnN0IHsgdXNlckdyb3Vwcywgc2lnbmluZ0tleXMgfSA9IHVzZXJHcm91cEtleXMoKTtcbiAgICAgIHByaXZhdGVLZXkgPSBzaWduaW5nS2V5c1t1c2VyR3JvdXBzW3RoaXMuYXR0cnMudXNlckdyb3VwSWRdXTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJpdmF0ZUtleSA9IHJlcXVpcmVVc2VyU2Vzc2lvbigpLmxvYWRVc2VyRGF0YSgpLmFwcFByaXZhdGVLZXk7XG4gICAgfVxuICAgIHJldHVybiBwcml2YXRlS2V5O1xuICB9XG5cbiAgc3RhdGljIG1vZGVsTmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSB8fCB0aGlzLm5hbWU7XG4gIH1cblxuICBtb2RlbE5hbWUoKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IG1vZGVsTmFtZSB9ID0gdGhpcy5jb25zdHJ1Y3RvciBhcyB0eXBlb2YgTW9kZWw7XG4gICAgcmV0dXJuIG1vZGVsTmFtZS5hcHBseSh0aGlzLmNvbnN0cnVjdG9yKTtcbiAgfVxuXG4gIGlzT3duZWRCeVVzZXIoKSB7XG4gICAgY29uc3Qga2V5cyA9IHVzZXJHcm91cEtleXMoKTtcbiAgICBpZiAodGhpcy5hdHRycy5zaWduaW5nS2V5SWQgPT09IGtleXMucGVyc29uYWwuX2lkKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuYXR0cnMudXNlckdyb3VwSWQpIHtcbiAgICAgIGxldCBpc093bmVkID0gZmFsc2U7XG4gICAgICBPYmplY3Qua2V5cyhrZXlzLnVzZXJHcm91cHMpLmZvckVhY2goKGdyb3VwSWQpID0+IHtcbiAgICAgICAgaWYgKGdyb3VwSWQgPT09IHRoaXMuYXR0cnMudXNlckdyb3VwSWQpIHtcbiAgICAgICAgICBpc093bmVkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gaXNPd25lZDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgc3RhdGljIG9uU3RyZWFtRXZlbnQgPSAoX3RoaXMsIFtldmVudF0pID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgeyBkYXRhIH0gPSBldmVudDtcbiAgICAgIGNvbnN0IGF0dHJzID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgICAgIGlmIChhdHRycyAmJiBhdHRycy5yYWRpa3NUeXBlID09PSBfdGhpcy5tb2RlbE5hbWUoKSkge1xuICAgICAgICBjb25zdCBtb2RlbCA9IG5ldyBfdGhpcyhhdHRycyk7XG4gICAgICAgIGlmIChtb2RlbC5pc093bmVkQnlVc2VyKCkpIHtcbiAgICAgICAgICBtb2RlbC5kZWNyeXB0KCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICBfdGhpcy5lbWl0dGVyLmVtaXQoRVZFTlRfTkFNRSwgbW9kZWwpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIF90aGlzLmVtaXR0ZXIuZW1pdChFVkVOVF9OQU1FLCBtb2RlbCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gY29uc29sZS5lcnJvcihlcnJvci5tZXNzYWdlKTtcbiAgICB9XG4gIH07XG5cbiAgc3RhdGljIGFkZFN0cmVhbUxpc3RlbmVyKGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XG4gICAgaWYgKCF0aGlzLmVtaXR0ZXIpIHtcbiAgICAgIHRoaXMuZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuZW1pdHRlci5nZXRMaXN0ZW5lcnMoKS5sZW5ndGggPT09IDApIHtcbiAgICAgIFN0cmVhbWVyLmFkZExpc3RlbmVyKChhcmdzOiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5vblN0cmVhbUV2ZW50KHRoaXMsIGFyZ3MpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIHRoaXMuZW1pdHRlci5hZGRMaXN0ZW5lcihFVkVOVF9OQU1FLCBjYWxsYmFjayk7XG4gIH1cblxuICBzdGF0aWMgcmVtb3ZlU3RyZWFtTGlzdGVuZXIoY2FsbGJhY2s6ICgpID0+IHZvaWQpIHtcbiAgICB0aGlzLmVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoRVZFTlRfTkFNRSwgY2FsbGJhY2spO1xuICAgIGlmICh0aGlzLmVtaXR0ZXIuZ2V0TGlzdGVuZXJzKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICBTdHJlYW1lci5yZW1vdmVMaXN0ZW5lcih0aGlzLm9uU3RyZWFtRXZlbnQpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGRlc3Ryb3koKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgYXdhaXQgdGhpcy5zaWduKCk7XG4gICAgYXdhaXQgdGhpcy5kZWxldGVGaWxlKCk7XG4gICAgcmV0dXJuIGRlc3Ryb3lNb2RlbCh0aGlzKTtcbiAgfVxuXG4gIC8vIEBhYnN0cmFjdFxuICBiZWZvcmVTYXZlKCkge31cblxuICAvLyBAYWJzdHJhY3RcbiAgYWZ0ZXJGZXRjaCgpIHt9XG59XG4iXX0=